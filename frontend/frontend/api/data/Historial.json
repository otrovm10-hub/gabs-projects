<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Historial de Tareas</title>

  <style>
    body {
      background-color: #1e1e1e;
      color: #ffffff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      text-align: center;
    }

    h1, h2, h3 {
      color: #ffc300;
    }

    #contenedor {
      max-width: 900px;
      margin: 20px auto;
      background: #2a2a2a;
      padding: 20px;
      border-radius: 10px;
      border-left: 5px solid #c1121f;
    }

    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      border: 2px solid #c1121f;
      background: #1e1e1e;
      color: #ffffff;
      font-size: 16px;
    }

    button {
      background: #ffc300;
      color: #1e1e1e;
      cursor: pointer;
      font-weight: bold;
    }

    button:hover {
      background: #c1121f;
      color: #ffffff;
    }

    .tarea-card {
      background: #2a2a2a;
      padding: 15px;
      margin: 15px 0;
      border-radius: 8px;
      border-left: 5px solid #ffc300;
      text-align: left;
    }

    .estado {
      font-weight: bold;
      margin-top: 5px;
    }

    .estado-terminada { color: #00ff88; }
    .estado-no_realizada { color: #ff4b4b; }

  </style>
</head>

<body>

  <h1>Historial de Tareas</h1>

  <div id="contenedor">

    <h3>Seleccione una fecha</h3>
    <input type="date" id="fechaSeleccionada">

    <button onclick="verPorFecha()">Ver por dÃ­a</button>
    <button onclick="verSemana()">Ver semana</button>
    <button onclick="verMes()">Ver mes</button>

    <h2 id="titulo"></h2>

    <div id="listaHistorial"></div>

  </div>

  <script>
    /* ============================================================
       CARGAR HISTORIAL COMPLETO (SOLO APROBADAS)
    ============================================================ */
    async function cargarHistorial() {
      return fetch("/admin/historial")
        .then(res => res.json())
        .catch(() => []);
    }

    /* ============================================================
       VISTA POR DÃA
    ============================================================ */
    async function verPorFecha() {
      const fecha = document.getElementById("fechaSeleccionada").value;
      if (!fecha) return alert("Seleccione una fecha");

      const historial = await cargarHistorial();

      document.getElementById("titulo").textContent = "Historial del " + fecha;

      const tareas = historial.filter(t => t.fecha === fecha);

      mostrarTareas(tareas);
    }

    /* ============================================================
       VISTA POR SEMANA
    ============================================================ */
    async function verSemana() {
      const fechaBase = document.getElementById("fechaSeleccionada").value;
      if (!fechaBase) return alert("Seleccione una fecha");

      const historial = await cargarHistorial();
      const cont = document.getElementById("listaHistorial");
      cont.innerHTML = "";

      document.getElementById("titulo").textContent = "Historial de la semana";

      const base = new Date(fechaBase);

      for (let i = 0; i < 7; i++) {
        const f = new Date(base);
        f.setDate(base.getDate() + i);
        const fecha = f.toISOString().split("T")[0];

        const titulo = document.createElement("h3");
        titulo.textContent = "ðŸ“… " + fecha;
        cont.appendChild(titulo);

        const tareas = historial.filter(t => t.fecha === fecha);

        if (tareas.length === 0) {
          cont.innerHTML += "<p>No hay tareas</p>";
        } else {
          tareas.forEach(t => crearTarjeta(t));
        }
      }
    }

    /* ============================================================
       VISTA POR MES
    ============================================================ */
    async function verMes() {
      const fechaBase = document.getElementById("fechaSeleccionada").value;
      if (!fechaBase) return alert("Seleccione una fecha");

      const historial = await cargarHistorial();
      const cont = document.getElementById("listaHistorial");
      cont.innerHTML = "";

      const base = new Date(fechaBase);
      const aÃ±o = base.getFullYear();
      const mes = base.getMonth();

      document.getElementById("titulo").textContent =
        "Historial de " + nombreMes(mes) + " " + aÃ±o;

      const ultimoDia = new Date(aÃ±o, mes + 1, 0).getDate();

      for (let dia = 1; dia <= ultimoDia; dia++) {
        const fecha = `${aÃ±o}-${String(mes + 1).padStart(2, "0")}-${String(dia).padStart(2, "0")}`;

        const titulo = document.createElement("h3");
        titulo.textContent = "ðŸ“… " + fecha;
        cont.appendChild(titulo);

        const tareas = historial.filter(t => t.fecha === fecha);

        if (tareas.length === 0) {
          cont.innerHTML += "<p>No hay tareas</p>";
        } else {
          tareas.forEach(t => crearTarjeta(t));
        }
      }
    }

    function nombreMes(m) {
      return [
        "Enero","Febrero","Marzo","Abril","Mayo","Junio",
        "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
      ][m];
    }

    /* ============================================================
       MOSTRAR TAREAS
    ============================================================ */
    function mostrarTareas(lista) {
      const cont = document.getElementById("listaHistorial");
      cont.innerHTML = "";

      if (lista.length === 0) {
        cont.innerHTML = "<p>No hay tareas registradas.</p>";
        return;
      }

      lista.forEach(t => crearTarjeta(t));
    }

    /* ============================================================
       TARJETA INDIVIDUAL
    ============================================================ */
    function crearTarjeta(t) {
      let estadoTexto = t.estado === "terminada" ? "ðŸŸ¢ Terminada" : "ðŸ”´ No realizada";
      let claseEstado = t.estado === "terminada" ? "estado-terminada" : "estado-no_realizada";

      const card = document.createElement("div");
      card.className = "tarea-card";

      card.innerHTML = `
        <strong>Empleado:</strong> ${t.nombre} (${t.id})<br>
        <strong>Fecha:</strong> ${t.fecha}<br>
        <strong>Tarea:</strong> ${t.tarea}<br>
        <div class="estado ${claseEstado}">Estado: ${estadoTexto}</div>
        ${t.obsAdmin ? `<div><strong>Obs. admin:</strong> ${t.obsAdmin}</div>` : ""}
        ${t.obsEmpleado ? `<div><strong>Obs. empleado:</strong> ${t.obsEmpleado}</div>` : ""}
        ${t.motivoNoRealizada ? `<div><strong>Motivo:</strong> ${t.motivoNoRealizada}</div>` : ""}
      `;

      document.getElementById("listaHistorial").appendChild(card);
    }

  </script>

</body>
</html>
