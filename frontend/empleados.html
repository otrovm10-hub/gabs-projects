<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel del Empleado</title>

  <link rel="manifest" href="/manifest-empleado.json">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      background-color: #1e1e1e;
      color: #ffffff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      text-align: center;
    }

    h1, h2, h3 {
      color: #ffc300;
    }

    #login, #panel {
      max-width: 900px;
      margin: 20px auto;
      background: #2a2a2a;
      padding: 20px;
      border-radius: 10px;
      border-left: 5px solid #c1121f;
    }

    input, button, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      border: 2px solid #c1121f;
      background: #1e1e1e;
      color: #ffffff;
      font-size: 16px;
    }

    button {
      background: #ffc300;
      color: #1e1e1e;
      cursor: pointer;
      font-weight: bold;
    }

    button:hover {
      background: #c1121f;
      color: #ffffff;
    }

    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    .cal-dia {
      background: #2a2a2a;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      border-left: 4px solid #c1121f;
      min-height: 80px;
    }

    .cal-dia:hover {
      background: #3a3a3a;
    }

    .tarea-card {
      background: #2a2a2a;
      padding: 15px;
      margin: 15px 0;
      border-radius: 8px;
      border-left: 5px solid #ffc300;
      text-align: left;
    }

    .btn-mini {
      width: auto;
      padding: 6px 10px;
      margin-right: 5px;
      margin-top: 5px;
      font-size: 14px;
      background: #ffc300;
      color: #1e1e1e;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-mini:hover {
      background: #c1121f;
      color: #ffffff;
    }

    #bienvenida {
      margin-top: 10px;
      font-style: italic;
      color: #ddd;
    }

    .foto-label {
      color: #ffc300;
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
  </style>
</head>

<body>

  <h1>Panel del Empleado</h1>

  <!-- LOGIN -->
  <div id="login">
    <h3>Ingrese sus credenciales</h3>
    <input type="text" id="usuario" placeholder="Usuario">
    <input type="password" id="clave" placeholder="Clave">

    <button type="button" onclick="login()">Entrar</button>
  </div>

  <!-- PANEL -->
  <div id="panel" style="display:none;">
    <h2 id="nombreEmpleado"></h2>
    <div id="bienvenida"></div>

    <h3>Calendario de tareas</h3>

    <div>
      <button type="button" onclick="mesAnterior()">‚Üê Mes anterior</button>
      <button type="button" onclick="mesSiguiente()">Mes siguiente ‚Üí</button>
    </div>

    <h3 id="tituloMes"></h3>

    <div id="calendario"></div>

    <h3 id="tituloDia"></h3>
    <div id="listaTareas"></div>
  </div>

  <script>
    const API = "https://gabs-backend-ultima.onrender.com";

    /* ---------------------------
       SUPABASE CONFIG
    ----------------------------*/
    const SUPABASE_URL = "https://yqfbgvjcpvbepaquzbkj.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_bkr2CZPPeb7opdgSAxeA7A_kD_YsNjO";
    const SUPABASE_BUCKET = "fotos";

    let supabaseClient = null;
    try {
      if (window.supabase && typeof window.supabase.createClient === "function") {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }
    } catch (e) {
      console.error("Error inicializando Supabase:", e);
    }

    /* ---------------------------
       VARIABLES
    ----------------------------*/
    let empleadoID = null;
    let nombreEmpleado = "";
    let fechaActual = new Date();
    let fechaSeleccionada = null;
    let intervaloRefresco = null;

    function escapeHTML(str) {
      if (!str) return "";
      return str.replace(/[&<>"']/g, m => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;"
      }[m]));
    }

    /* ---------------------------
       LOGIN
    ----------------------------*/
    function login() {
      const usuario = document.getElementById("usuario").value.trim();
      const clave = document.getElementById("clave").value.trim();

      if (!usuario || !clave) {
        alert("Ingrese usuario y clave");
        return;
      }

      fetch(`${API}/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ usuario, clave })
      })
      .then(res => res.json())
      .then(data => {
        if (!data.ok) {
          alert("Credenciales incorrectas");
          return;
        }

        empleadoID = data.id;
        nombreEmpleado = data.nombre;

        document.getElementById("login").style.display = "none";
        document.getElementById("panel").style.display = "block";

        document.getElementById("nombreEmpleado").textContent =
          "Hola, " + escapeHTML(nombreEmpleado);

        document.getElementById("bienvenida").textContent =
          "Bienvenido a tu panel de tareas.";

        cargarCalendario();
      })
      .catch(err => {
        console.error("Error en login:", err);
        alert("Error al conectar con el servidor.");
      });
    }

    /* ---------------------------
       CALENDARIO
    ----------------------------*/
    function cargarCalendario() {
      const a√±o = fechaActual.getFullYear();
      const mes = fechaActual.getMonth();

      document.getElementById("tituloMes").textContent =
        nombreMes(mes) + " " + a√±o;

      const primerDia = new Date(a√±o, mes, 1);
      const ultimoDia = new Date(a√±o, mes + 1, 0);

      const cont = document.getElementById("calendario");
      cont.innerHTML = `<div class="cal-grid"></div>`;
      const grid = cont.querySelector(".cal-grid");

      for (let i = 0; i < primerDia.getDay(); i++) {
        grid.innerHTML += `<div></div>`;
      }

      for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
        const fecha = `${a√±o}-${String(mes + 1).padStart(2, "0")}-${String(dia).padStart(2, "0")}`;

        grid.innerHTML += `
          <div class="cal-dia" onclick="verDia('${fecha}')">
            <strong>${dia}</strong><br>
            <div id="info-${fecha}">Cargando...</div>
          </div>
        `;
      }

      cargarResumenMes(a√±o, mes);
    }

    function cargarResumenMes(a√±o, mes) {
      const ultimoDia = new Date(a√±o, mes + 1, 0).getDate();

      for (let dia = 1; dia <= ultimoDia; dia++) {
        const fecha = `${a√±o}-${String(mes + 1).padStart(2, "0")}-${String(dia).padStart(2, "0")}`;

        fetch(`${API}/tareas-del-dia/${empleadoID}?fecha=${fecha}`)
          .then(res => res.json())
          .then(data => {
            const tareas = data.tareas || [];
            const div = document.getElementById("info-" + fecha);

            if (!div) return;

            if (tareas.length === 0) {
              div.textContent = "0 tareas";
              return;
            }

            const colores = tareas.map(t => {
              if (t.estado === "en_proceso") return "üü°";
              if (t.estado === "devuelto") return "üü†";
              return "‚ö™";
            }).join("");

            div.innerHTML = `${tareas.length} tareas<br>${colores}`;
          })
          .catch(err => console.error("Error cargando resumen:", err));
      }
    }

    function mesAnterior() {
      fechaActual.setMonth(fechaActual.getMonth() - 1);
      cargarCalendario();
    }

    function mesSiguiente() {
      fechaActual.setMonth(fechaActual.getMonth() + 1);
      cargarCalendario();
    }

    function nombreMes(m) {
      return [
        "Enero","Febrero","Marzo","Abril","Mayo","Junio",
        "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
      ][m];
    }

    /* ---------------------------
       VER TAREAS DEL D√çA
    ----------------------------*/
    function verDia(fecha) {
      fechaSeleccionada = fecha;

      if (intervaloRefresco) clearInterval(intervaloRefresco);
      intervaloRefresco = setInterval(cargarTareasDelDia, 5000);

      cargarTareasDelDia();
    }

    function cargarTareasDelDia() {
      if (!fechaSeleccionada) return;

      fetch(`${API}/tareas-del-dia/${empleadoID}?fecha=${fechaSeleccionada}`)
        .then(res => res.json())
        .then(data => mostrarTareas(fechaSeleccionada, data.tareas || []))
        .catch(err => console.error("Error cargando tareas del d√≠a:", err));
    }

    /* ---------------------------
       MOSTRAR TAREAS
    ----------------------------*/
    function mostrarTareas(fecha, tareas) {
      document.getElementById("tituloDia").textContent = "Tareas del " + fecha;

      const cont = document.getElementById("listaTareas");
      cont.innerHTML = "";

      const visibles = tareas.filter(t =>
        t.estado === "pendiente" ||
        t.estado === "en_proceso" ||
        t.estado === "devuelto"
      );

      if (visibles.length === 0) {
        cont.innerHTML = "<p>No tienes tareas este d√≠a.</p>";
        return;
      }

      visibles.forEach(t => crearTarjeta(t, fecha));
    }

    /* ---------------------------
       CREAR TARJETA
    ----------------------------*/
    function crearTarjeta(t, fecha) {
      const card = document.createElement("div");
      card.className = "tarea-card";

      const icono =
        t.estado === "en_proceso" ? "üü°" :
        t.estado === "devuelto" ? "üü†" :
        "‚ö™";

      const idSeguro = crypto.randomUUID();

      card.innerHTML = `
        <strong>Tarea:</strong> ${escapeHTML(t.tarea)}<br>
        <p><strong>Estado:</strong> ${icono} ${escapeHTML(t.estado)}</p>

        <label class="foto-label">Foto ANTES:</label>
        <input type="file" id="antes-${idSeguro}" accept="image/*" multiple="false">

        <label class="foto-label">Foto DESPU√âS:</label>
        <input type="file" id="despues-${idSeguro}" accept="image/*" multiple="false">

        <label class="foto-label">Observaci√≥n:</label>
        <textarea id="obs-${idSeguro}" placeholder="Escriba una observaci√≥n..."></textarea>

        <button class="btn-mini" onclick="enviarTarea('${t.tarea}', '${fecha}', '${idSeguro}')">
          Enviar fotos
        </button>

        <button class="btn-mini"
                onclick="cambiarEstado('${t.tarea}', 'en_proceso', '${fecha}')">
          En proceso
        </button>

        <button class="btn-mini"
                onclick="cambiarEstado('${t.tarea}', 'terminada', '${fecha}')">
          Terminada
        </button>

        <button class="btn-mini"
                onclick="marcarNoRealizada('${t.tarea}', '${fecha}')">
          No realizada
        </button>

        <button class="btn-mini"
                onclick="agregarObservacion('${t.tarea}', '${fecha}')">
          Observaci√≥n
        </button>
      `;

      document.getElementById("listaTareas").appendChild(card);
    }

    /* ---------------------------
       SUBIDA DIRECTA A SUPABASE
    ----------------------------*/
    async function enviarTarea(tarea, fecha, idSeguro) {
      if (!supabaseClient) {
        alert("No se pudo inicializar el m√≥dulo de fotos (Supabase).");
        return;
      }

      const fotoAntes = document.getElementById(`antes-${idSeguro}`).files[0];
      const fotoDespues = document.getElementById(`despues-${idSeguro}`).files[0];
      const obsEmpleado = document.getElementById(`obs-${idSeguro}`).value;

      console.log("ANTES:", fotoAntes);
      console.log("DESPUES:", fotoDespues);

      if (!fotoAntes || !fotoDespues) {
        alert("Debe subir ambas fotos.");
        return;
      }

      const pathAntes = `empleados/${empleadoID}/${fecha}/${tarea}-antes-${Date.now()}.jpg`;
      const pathDespues = `empleados/${empleadoID}/${fecha}/${tarea}-despues-${Date.now()}.jpg`;

      try {
        await supabaseClient.storage.from(SUPABASE_BUCKET).upload(pathAntes, fotoAntes);
        await supabaseClient.storage.from(SUPABASE_BUCKET).upload(pathDespues, fotoDespues);

        const urlAntes = supabaseClient.storage.from(SUPABASE_BUCKET).getPublicUrl(pathAntes).data.publicUrl;
        const urlDespues = supabaseClient.storage.from(SUPABASE_BUCKET).getPublicUrl(pathDespues).data.publicUrl;

        await fetch(`${API}/empleado/subida-directa`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            empleadoId: empleadoID,
            fecha,
            tarea,
            fotoAntes: urlAntes,
            fotoDespues: urlDespues,
            obsEmpleado
          })
        });

        alert("Tarea enviada correctamente.");
        cargarTareasDelDia();
      } catch (e) {
        console.error("Error subiendo fotos:", e);
        alert("Error al subir las fotos.");
      }
    }

    /* ---------------------------
       CAMBIAR ESTADO
    ----------------------------*/
    function cambiarEstado(tarea, estado, fecha) {
      fetch(`${API}/guardar-estado`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          empleado: empleadoID,
          fecha,
          tarea: tarea.trim(),
          estado
        })
      })
      .then(() => cargarTareasDelDia())
      .catch(err => console.error("Error cambiando estado:", err));
    }

    function marcarNoRealizada(tarea, fecha) {
      const motivo = prompt("Motivo de no realizaci√≥n:");
      if (!motivo) return;

      fetch(`${API}/guardar-estado`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          empleado: empleadoID,
          fecha,
          tarea: tarea.trim(),
          estado: "no_realizada",
          motivoNoRealizada: motivo
        })
      })
      .then(() => cargarTareasDelDia())
      .catch(err => console.error("Error marcando no realizada:", err));
    }

    function agregarObservacion(tarea, fecha) {
      const obs = prompt("Escribe tu observaci√≥n:");
      if (!obs) return;

      fetch(`${API}/guardar-observacion`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          empleado: empleadoID,
          fecha,
          tarea: tarea.trim(),
          observacion: obs
        })
      })
      .then(() => cargarTareasDelDia())
      .catch(err => console.error("Error guardando observaci√≥n:", err));
    }
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/service-worker.js");
    }
  </script>

</body>
</html>
