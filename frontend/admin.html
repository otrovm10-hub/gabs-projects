<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel del Administrador</title>
  <link rel="manifest" href="manifest-admin.json">

  <style>
    body {
      background-color: #1e1e1e;
      color: #ffffff;
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
    }

    h1, h2, h3 {
      color: #ffc300;
    }

    #login, #panel, #calendario {
      max-width: 900px;
      margin: 20px auto;
      background: #2a2a2a;
      padding: 20px;
      border-radius: 10px;
      border-left: 5px solid #c1121f;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      border: 2px solid #c1121f;
      background: #1e1e1e;
      color: #ffffff;
      font-size: 16px;
    }

    button {
      background: #ffc300;
      color: #1e1e1e;
      cursor: pointer;
      font-weight: bold;
    }

    button:hover {
      background: #c1121f;
      color: #ffffff;
    }

    .tarea-card {
      background: #2a2a2a;
      padding: 15px;
      margin: 15px 0;
      border-radius: 8px;
      border-left: 5px solid #ffc300;
      text-align: left;
    }

    .btn-mini {
      width: auto;
      padding: 6px 10px;
      margin-right: 5px;
      margin-top: 5px;
      font-size: 14px;
      background: #ffc300;
      color: #1e1e1e;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-mini:hover {
      background: #c1121f;
      color: #ffffff;
    }

    /* -------------------------
       CALENDARIO
    --------------------------*/
    #cal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    #cal-header button {
      background: #ffc300;
      color: #1e1e1e;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    #cal-header button:hover {
      background: #c1121f;
      color: #fff;
    }

    #cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    .cal-dia {
      background: #1e1e1e;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #444;
      cursor: pointer;
    }

    .cal-dia:hover {
      background: #333;
    }

    .cal-dia.con-tareas {
      border-left: 5px solid #ffc300;
    }

    .cal-dia.aprobadas {
      border-left: 5px solid #4caf50;
    }

    .cal-dia.devuelta {
      border-left: 5px solid #c1121f;
    }
  </style>
</head>

<body>

  <h1>Panel del Administrador</h1>

  <!-- CALENDARIO -->
  <div id="calendario">
    <h2>Calendario</h2>

    <div id="cal-header">
      <button id="prevMes">◀</button>
      <span id="mesActual"></span>
      <button id="nextMes">▶</button>
    </div>

    <div id="cal-grid"></div>
  </div>

  <!-- LOGIN -->
  <div id="login">
    <h3>Ingrese clave de administrador</h3>
    <input type="password" id="claveAdmin" placeholder="Clave">
    <button onclick="entrarAdmin()">Entrar</button>
  </div>

  <!-- PANEL -->
  <div id="panel" style="display:none;">
    <h2 id="tituloFecha"></h2>

    <input type="date" id="fechaSeleccionada">
    <button onclick="verFecha()">Ver tareas</button>

    <h3>Agregar nueva tarea</h3>
    <select id="selectEmpleado"></select>
    <select id="selectCategoria"></select>
    <select id="selectTarea"></select>
    <button onclick="agregarTarea()">Agregar</button>

    <h3>Tareas del día</h3>
    <div id="listaTareas"></div>
  </div>

  <script>
    const API = "https://gabs-backend-ultima.onrender.com";

    function escapeHTML(str) {
      if (!str) return "";
      return str.replace(/[&<>"']/g, m => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;"
      }[m]));
    }

    /* ---------------------------
       LOGIN ADMIN
    ----------------------------*/
    function entrarAdmin() {
      const clave = document.getElementById("claveAdmin").value.trim();
      if (clave !== "admin123") {
        alert("Clave incorrecta");
        return;
      }

      document.getElementById("login").style.display = "none";
      document.getElementById("panel").style.display = "block";

      cargarEmpleados();
      cargarCatalogo();
    }

    /* ---------------------------
       CARGAR EMPLEADOS
    ----------------------------*/
    function cargarEmpleados() {
      fetch(`${API}/empleados`)
        .then(res => res.json())
        .then(empleados => {
          const select = document.getElementById("selectEmpleado");
          select.innerHTML = "";

          empleados.forEach(e => {
            const option = document.createElement("option");
            option.textContent = e.name;
            option.value = e.id;
            select.appendChild(option);
          });
        });
    }

    /* ---------------------------
       CARGAR CATALOGO
    ----------------------------*/
    function cargarCatalogo() {
      fetch(`${API}/catalogo`)
        .then(res => res.json())
        .then(data => {
          const selectCat = document.getElementById("selectCategoria");
          const selectTar = document.getElementById("selectTarea");

          selectCat.innerHTML = "";
          selectTar.innerHTML = "";

          Object.keys(data).forEach(cat => {
            const opt = document.createElement("option");
            opt.textContent = cat;
            opt.value = cat;
            selectCat.appendChild(opt);
          });

          selectCat.onchange = () => {
            const tareas = data[selectCat.value] || [];
            selectTar.innerHTML = "";
            tareas.forEach(t => {
              const opt = document.createElement("option");
              opt.textContent = t;
              opt.value = t;
              selectTar.appendChild(opt);
            });
          };

          selectCat.onchange();
        });
    }

    /* ---------------------------
       VER FECHA
    ----------------------------*/
    function verFecha() {
      const fecha = document.getElementById("fechaSeleccionada").value;
      if (!fecha) return;

      document.getElementById("tituloFecha").textContent = "Tareas del " + fecha;

      fetch(`${API}/admin/tareas-completas?fecha=${fecha}`)
        .then(res => res.json())
        .then(tareas => mostrarTareas(fecha, tareas));
    }

    /* ---------------------------
       MOSTRAR TAREAS (CORREGIDO)
    ----------------------------*/
    function mostrarTareas(fecha, tareas) {
      const cont = document.getElementById("listaTareas");
      cont.innerHTML = "";

      if (tareas.length === 0) {
        cont.innerHTML = "<p>No hay tareas para este día.</p>";
        return;
      }

      tareas.forEach(t => {
        const card = document.createElement("div");
        card.className = "tarea-card";

        card.innerHTML = `
          <strong>Empleado:</strong> ${escapeHTML(t.nombre)}<br>
          <strong>Tarea:</strong> ${escapeHTML(t.tarea)}<br>
          <strong>Estado:</strong> ${escapeHTML(t.estado)}<br><br>

          ${t.fotoAntes ? `
            <p><strong>Foto ANTES:</strong><br>
            <img src="${t.fotoAntes}" style="width:150px;border-radius:8px;margin-top:5px;"></p>
          ` : "<p><em>Sin foto ANTES</em></p>"}

          ${t.fotoDespues ? `
            <p><strong>Foto DESPUÉS:</strong><br>
            <img src="${t.fotoDespues}" style="width:150px;border-radius:8px;margin-top:5px;"></p>
          ` : "<p><em>Sin foto DESPUÉS</em></p>"}

          ${t.obsEmpleado ? `<p><strong>Obs empleado:</strong> ${escapeHTML(t.obsEmpleado)}</p>` : ""}
          ${t.obsAdmin ? `<p><strong>Obs admin:</strong> ${escapeHTML(t.obsAdmin)}</p>` : ""}
          ${t.motivoNoRealizada ? `<p><strong>Motivo:</strong> ${escapeHTML(t.motivoNoRealizada)}</p>` : ""}

          <button class="btn-mini" onclick="aprobar('${t.id}', '${fecha}', '${t.tarea}')">Aprobar</button>
          <button class="btn-mini" onclick="devolver('${t.id}', '${fecha}', '${t.tarea}')">Devolver</button>
          <button class="btn-mini" onclick="reprogramar('${t.id}', '${fecha}', '${t.tarea}')">Reprogramar</button>
          <button class="btn-mini" onclick="obsAdmin('${t.id}', '${fecha}', '${t.tarea}')">Obs admin</button>
        `;

        cont.appendChild(card);
      });
    }

    /* ---------------------------
       APROBAR
    ----------------------------*/
    function aprobar(id, fecha, tarea) {
      const observacionAdmin = prompt("Observación del administrador:");
      fetch(`${API}/admin/aprobar`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, fecha, tarea, observacionAdmin })
      })
      .then(() => verFecha());
    }

    /* ---------------------------
       DEVOLVER
    ----------------------------*/
    function devolver(id, fecha, tarea) {
      const motivo = prompt("Motivo de devolución:");
      fetch(`${API}/admin/devolver`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, fecha, tarea, motivo })
      })
      .then(() => verFecha());
    }

    /* ---------------------------
       REPROGRAMAR
    ----------------------------*/
    function reprogramar(id, fecha, tarea) {
      const nuevaFecha = prompt("Nueva fecha (YYYY-MM-DD):");
      if (!nuevaFecha) return;

      const observacionAdmin = prompt("Observación del administrador:");

      fetch(`${API}/admin/reprogramar`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          id,
          fecha,
          tarea,
          nuevaFecha,
          observacionAdmin
        })
      })
      .then(() => verFecha());
    }

    /* ---------------------------
       OBS ADMIN
    ----------------------------*/
    function obsAdmin(id, fecha, tarea) {
      const observacionAdmin = prompt("Observación del administrador:");
      if (!observacionAdmin) return;

      fetch(`${API}/guardar-observacion-admin`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, fecha, tarea, observacionAdmin })
      })
      .then(() => verFecha());
    }

    /* ---------------------------
       CALENDARIO
    ----------------------------*/
    const meses = [
      "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
      "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
    ];

    let fechaActual = new Date();

    function renderCalendario() {
      const año = fechaActual.getFullYear();
      const mes = fechaActual.getMonth();

      document.getElementById("mesActual").textContent = `${meses[mes]} ${año}`;

      const primerDia = new Date(año, mes, 1).getDay();
      const ultimoDia = new Date(año, mes + 1, 0).getDate();

      const grid = document.getElementById("cal-grid");
      grid.innerHTML = "";

      for (let i = 0; i < primerDia; i++) {
        grid.appendChild(document.createElement("div"));
      }

      for (let dia = 1; dia <= ultimoDia; dia++) {
        const celda = document.createElement("div");
        celda.className = "cal-dia";
        celda.textContent = dia;

        const fechaStr = `${año}-${String(mes + 1).padStart(2, "0")}-${String(dia).padStart(2, "0")}`;

        fetch(`${API}/admin/tareas-completas?fecha=${fechaStr}`)
          .then(res => res.json())
          .then(tareas => {
            if (tareas.length > 0) {
              celda.classList.add("con-tareas");

              const estados = tareas.map(t => t.estado);

              if (estados.includes("Aprobada")) celda.classList.add("aprobadas");
              if (estados.includes("Devuelta")) celda.classList.add("devuelta");
            }
          });

        celda.onclick = () => {
          document.getElementById("fechaSeleccionada").value = fechaStr;
          verFecha();
        };

        grid.appendChild(celda);
      }
    }

    document.getElementById("prevMes").onclick = () => {
      fechaActual.setMonth(fechaActual.getMonth() - 1);
      renderCalendario();
    };

    document.getElementById("nextMes").onclick = () => {
      fechaActual.setMonth(fechaActual.getMonth() + 1);
      renderCalendario();
    };

    renderCalendario();
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }
  </script>

</body>
</html>
